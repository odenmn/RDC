<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>审核</title>
</head>
<body>
<div id="app">
    <h2 style="text-align: center">审核列表</h2>
    <div>
        <template>
            <el-table
                    :data="tableData"
                    stripe
                    style="width: 100%">
                <el-table-column
                        type="index"
                        width="50">
                </el-table-column>
                <el-table-column
                        prop="uploadTime"
                        label="日期"
                        align="center"
                        :formatter="formatTime">
                </el-table-column>
                <el-table-column
                        prop="content"
                        label="类型"
                        align="center">
                </el-table-column>
                <el-table-column
                        prop="statusStr"
                        label="当前状态"
                        align="center">
                </el-table-column>
                <el-table-column
                        label="操作"
                        align="center">
                    <template slot-scope="scope">
                        <el-button type="primary" @click="processingReview(scope.row.uploadWorkId,scope.row.id,scope.row.content)">处理</el-button>
                    </template>
                </el-table-column>
            </el-table>
        </template>
        <!--分页工具条-->
        <el-pagination
                @size-change="handleSizeChange"
                @current-change="handleCurrentChange"
                :current-page="currentPage"
                :page-sizes="[5, 10, 15, 20]"
                :page-size="5"
                layout="total, sizes, prev, pager, next, jumper"
                :total="totalCount">
        </el-pagination>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="element-ui/lib/index.js"></script>
<link rel="stylesheet" href="element-ui/lib/theme-chalk/index.css">

<script>
    new Vue({
        el: '#app',
        data() {
            return {
                currentPage: 1,
                pageSize: 5,
                tableData: [],
                totalCount: ''
            }
        }
        ,
        mounted() {
            this.fetchReviews();
        },
        methods: {
            // 时间格式化方法
            formatTime(row, column, cellValue) {
                if (!cellValue) return '未知时间';
                // 处理Java LocalDateTime格式（兼容带毫秒的情况）
                const dateStr = cellValue.replace('T', ' ').split('.')[0];
                const date = new Date(dateStr);
                // 补零函数
                const pad = n => n.toString().padStart(2, '0');
                return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}
                ${pad(date.getHours())}:${pad(date.getMinutes())}`;
            },
            fetchReviews() {
                axios.get(`/XuJunxi_CloudMusic/admin/getPendingReviews?currentPage=${this.currentPage}&pageSize=${this.pageSize}`)
                    .then(response => {
                        this.tableData = response.data.pageBean.rows;
                        this.totalCount = response.data.pageBean.totalCount;
                    })
                    .catch(error => {
                        console.error('获取待审核歌曲失败:', error);
                    });
            },
            processingReview(uploadWorkId, id, content) {
                if (content === '歌曲') {
                    console.log("要处理的歌曲ID:"+uploadWorkId);
                    axios.post('/XuJunxi_CloudMusic/admin/processingReview', new URLSearchParams({
                        reviewId: id
                    }), {
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    })
                        .then(response => {
                            if (response.data.success) {
                                this.fetchReviews(); // 刷新待审核记录
                                // 跳转到处理页面
                                window.location.href = `processSong.html?uploadWorkId=${uploadWorkId}&reviewId=${id}`;
                            } else {
                                console.error('处理审核失败:', response.data.message);
                            }
                        })
                        .catch(error => {
                            console.error('处理审核失败:', error);
                        });
                } else {
                    console.log("要处理的专辑ID:"+uploadWorkId);
                    axios.post('/XuJunxi_CloudMusic/admin/processingReview', new URLSearchParams({
                        reviewId: id
                    }), {
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    })
                        .then(response => {
                            if (response.data.success) {
                                this.fetchReviews(); // 刷新待审核记录
                                // 跳转到处理页面
                                window.location.href = `processAlbum.html?albumId=${uploadWorkId}&reviewId=${id}`;
                            }
                        })
                }
            },
            approveSong(id) {
                axios.post('/admin/approveSong', { reviewId: id })
                    .then(response => {
                        this.fetchSongs();
                    })
                    .catch(error => {
                        console.error('审核通过失败:', error);
                    });
            },
            rejectSong(id) {
                axios.post('/admin/rejectSong', { reviewId: id })
                    .then(response => {
                        this.fetchSongs();
                    })
                    .catch(error => {
                        console.error('拒绝失败:', error);
                    });
            },
            handleSizeChange(val) {
                // console.log(`每页 ${val} 条`);
                this.currentPage=val;
                this.fetchReviews();
            },
            handleCurrentChange(val) {
                // console.log(`当前页: ${val}`);
                this.currentPage=val;
                this.fetchReviews();
            }
        }
    })
</script>
</body>
</html>