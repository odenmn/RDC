<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>音乐广场</title>
    <link href="css/home.css" rel="stylesheet">
</head>
<body>
<div id="app" class="container">
        <div class="header">
            <h1>音乐广场</h1>
        </div>
<!--        <div class="search-bar">-->
<!--            <input type="text" class="search-input" id="search-input" placeholder="搜索歌曲、专辑、用户、歌单">-->
<!--            <button class="search-button" onclick="search()">搜索</button>-->
<!--        </div>-->
<!--        <div id="search-results">-->
<!--            &lt;!&ndash; 搜索结果将动态插入到这里 &ndash;&gt;-->
<!--        </div>-->
        <div>
            <a href="search.html">搜索</a>
        </div>
        <div class="recommend-section">
            <h2>每日推荐</h2>
            <div v-if="loading">加载中...</div>
            <div v-else>
                <div v-for="song in recommendations" :key="song.id" class="song-item">
                    <div class="song-info">
                        <h3>歌曲：{{ song.title }}</h3>
                        <p>歌手：{{ getAuthorName(song.authorId) }}</p>
                        <button class="view-button" @click="viewSong(song.id)">查看</button>
                    </div>
                </div>
                <div v-if="error" class="error">{{ error }}</div>
            </div>
        </div>
    </div>
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    new Vue({
        el: '#app',
        data: {
            recommendations: [],
            authors: new Map(), // 存储作者信息
            loading: false,
            error: '',
        },
        created() {
            this.fetchRandomRecommendations();
        },
        methods: {
            async fetchRandomRecommendations() {
                this.loading = true;
                try {
                    const response = await axios.get('/XuJunxi_CloudMusic/song/getRandomRecommendations');
                    if (response.data.success) {
                        this.recommendations = response.data.recommendations;
                        // 批量获取作者信息
                        await this.loadAuthors();
                    } else {
                        this.error = '获取推荐失败：' + (response.data.message || '未知错误');
                    }
                } catch (err) {
                    console.error('请求失败:', err);
                    this.error = '网络请求失败';
                } finally {
                    this.loading = false;
                }
            },
            async loadAuthors() {
                const authorIds = [...new Set(this.recommendations.map(song => song.authorId))];
                for (const id of authorIds) {
                    try {
                        const response = await axios.get(`/XuJunxi_CloudMusic/user/getUserById?id=${id}`);
                        if (response.data.success) {
                            this.authors.set(id, response.data.user.username);
                            console.log(`获取作者${response.data.user.username}信息成功`);
                        }
                    } catch (err) {
                        console.warn(`获取作者${id}信息失败:`, err);
                    }
                }
            },
            getAuthorName(authorId) {
                return this.authors.get(authorId) || '未知作者';
            },
            viewSong(songId) {
                // 页面跳转
                window.location.href = `song.html?id=${songId}`;
            }
        }
    })
</script>
</body>
</html>